# GAP_NewLoanCash Data Dictionary

## Program Variables

This OmniScript program uses dynamically declared variables rather than traditional COBOL WORKING-STORAGE. Below is the comprehensive data dictionary for all variables used in the program.

---

### **sd080**
- **Data Type**: Numeric
- **Initial Value**: 99999999
- **Purpose**: System default value, likely used for OmniScript runtime configuration or error handling threshold
- **Usage Pattern**: Set once at program initialization, not modified thereafter
- **Business Significance**: May serve as a sentinel value or maximum record limit
- **Buffer/Limit Notes**: Fixed value, no overflow risk

---

### **FileName**
- **Data Type**: String (Text)
- **Format**: `$XDAT\OTDALY.OMNISCRIPT.C1.NEWLOANOFFSET.YYYYMMDD.HHMMSS.DAT`
- **Purpose**: Output file path for C1 activity records generated by the script
- **Initialization**: Constructed using environment variable `$XDAT`, current date, and current time
- **Usage Pattern**: 
  - Built at line 13-14
  - Used to open output file at line 16
  - Read-only after initialization
- **Business Significance**: Unique timestamped output file for cash reconciliation activity
- **Example Value**: `C:\DATA\OTDALY.OMNISCRIPT.C1.NEWLOANOFFSET.20231221.143022.DAT`
- **Validation**: Depends on `$XDAT` environment variable being set correctly

---

### **RunDate**
- **Data Type**: Numeric (Date - 8 digits YYYYMMDD)
- **Purpose**: The business date for which the script is running (typically from batch scheduler)
- **Initialization**: Retrieved from environment variable `$RUN-DATE`, validated using `OcDate_Valid()`
- **Usage Pattern**:
  - Read from environment at line 18
  - Validated at line 19
  - Used to calculate SevenDaysAgo and LastBusiness dates
- **Business Significance**: Critical for determining date range for position account queries
- **Error Handling**: Falls back to current date if not valid or not set
- **Date Range**: Valid dates only (enforced by OcDate_Valid)

---

### **SevenDaysAgo**
- **Data Type**: Numeric (Date - 8 digits YYYYMMDD)
- **Purpose**: Start date for querying position accounts (7 calendar days before RunDate)
- **Calculation**: `OcDate_AddDays(RunDate, -7)` or `OcDate_AddDays(OcDate_Current(), -7)`
- **Usage Pattern**: 
  - Calculated at line 20 or 23
  - Used as `datelo` parameter in `poppobj_view()` query at line 28
  - Read-only after calculation
- **Business Significance**: Defines the lookback window for finding new loan position records
- **Date Range**: Always 7 calendar days before run date

---

### **LastBusiness**
- **Data Type**: Numeric (Date - 8 digits YYYYMMDD)
- **Purpose**: Last business day before RunDate (used as effective date for C1 activity records)
- **Calculation**: `OcDate_AddBusDays(RunDate, -1)` or `OcDate_AddBusDays(OcDate_Current(), -1)`
- **Usage Pattern**:
  - Calculated at line 21 or 24
  - Used as `datehi` parameter in `poppobj_view()` query at line 28
  - Used as effective date in output record at line 44
  - Read-only after calculation
- **Business Significance**: Critical for dating the generated C1 activity records to the prior business day
- **Business Rule**: Always a valid business day (weekends and holidays skipped)

---

### **RKPlan**
- **Data Type**: String (6 characters)
- **Purpose**: Plan identifier from POPP position records (e.g., retirement plan account number)
- **Source**: Data element 030 from POPP object
- **Usage Pattern**:
  - Read from POPP at line 30 (initial read in loop)
  - Re-read at line 39 (redundant assignment within condition)
  - Used in SSSA query at line 58
  - Written to output record at line 42 (positions 5-10)
- **Business Significance**: Links position activity to specific retirement plan
- **Validation**: Must not be empty string for SSSA query (line 57)
- **Mutation Points**: Read from database, not modified

---

### **TradeDate**
- **Data Type**: Numeric (Date - 8 digits YYYYMMDD)
- **Purpose**: Trade date of the position record
- **Source**: Data element 008 from POPP object
- **Usage Pattern**:
  - Read from POPP at line 31 (initial read)
  - Re-read at line 40 (redundant assignment)
  - Used in SSSA query at line 58
- **Business Significance**: Identifies the original trade date for position activity
- **Validation**: Must not be 0 for SSSA query (line 57)
- **Mutation Points**: Read from database, not modified

---

### **Secondary1Buys**
- **Data Type**: Numeric (likely decimal with 2 decimal places)
- **Purpose**: Dollar amount of secondary market buys for loan pool securities
- **Source**: Initially from data element 741 from POPP object, may be recalculated from SSSA
- **Usage Pattern**:
  - Read from POPP at line 32
  - Checked for non-zero at line 34 (triggers SSSA reversal check)
  - **MUTATED** in CHECK.SSSA routine (line 69) based on SSSA activity
  - Compared with PriorCashApplied at line 38
  - Written to POPP data element 877 if mismatch (line 51)
- **Business Significance**: Represents the net amount of loan buys after accounting for reversals
- **Special Handling**: 
  - Must account for SSSA reversal activity (XI/S transactions)
  - May be adjusted from original POPP value
- **Mutation Risk**: HIGH - Modified in subroutine, must ensure correct order of operations

---

### **Secondary1Sells**
- **Data Type**: Numeric (declared but never used)
- **Purpose**: Intended for dollar amount of secondary market sells (currently unused)
- **Usage Pattern**: Declared at line 12 but never assigned or referenced
- **Business Significance**: Reserved for future use when sell-side activity needs to be processed
- **Technical Debt**: Variable declared but not implemented, suggests incomplete feature

---

### **PriorCashApplied**
- **Data Type**: Numeric (likely decimal with 2 decimal places)
- **Purpose**: Previously recorded cash amount in POPP data element 877 (User Defined Field 1)
- **Source**: Data element 877 from POPP object
- **Usage Pattern**:
  - Read from POPP at line 33
  - Compared with Secondary1Buys at line 38
  - If mismatch, triggers C1 activity generation
- **Business Significance**: Used to detect if position record has already been processed
- **Idempotency Check**: Prevents duplicate C1 activity generation
- **Expected Value**: Should equal Secondary1Buys if record was already processed

---

### **NewLoanUnits**
- **Data Type**: Numeric (decimal with 2 decimal places, formatted with 12 integer digits)
- **Purpose**: Negated value of Secondary1Buys for the right side (AC) of cash reconciliation
- **Calculation**: `0 - Secondary1Buys`
- **Usage Pattern**:
  - Calculated at line 41
  - Formatted and written to output record at line 47 (positions 116-130)
- **Business Significance**: Represents the cash impact of new loans (negative for asset purchases)
- **Format**: `Z,12V2-` (12 digits with commas, 2 decimals, trailing sign)
- **Business Rule**: Always negative value (asset purchase reduces cash)

---

### **TrustAccount**
- **Data Type**: String (32 characters)
- **Purpose**: Trust account number associated with the plan position
- **Source**: Data element 01510 from POPP object
- **Usage Pattern**:
  - Read from POPP at line 42
  - Written to output record at line 45 (positions 40-71)
- **Business Significance**: Links cash activity to specific trust account for reconciliation
- **Format**: 32-character field in output record

---

### **Line**
- **Data Type**: String (variable length, likely 150+ characters based on field positions)
- **Purpose**: Output record buffer for C1 activity file
- **Usage Pattern**:
  - Initialized and populated using OcText_Set() calls (lines 43-48)
  - Written to output file at line 49
- **Record Layout** (Fixed-width fields):
  - Positions 1-4: 'C100' (record type)
  - Positions 5-10: RKPlan (6 chars)
  - Positions 31-38: LastBusiness date (8 digits)
  - Positions 40-71: TrustAccount (32 chars)
  - Positions 73-92: '000000000000000    2' (20 chars - position indicator)
  - Position 115: '0' (1 char - flag)
  - Positions 116-130: NewLoanUnits (15 chars formatted)
  - Positions 134-138: '00339' (5 chars - transaction code)
- **Business Significance**: Standardized C1 cash reconciliation activity record
- **Validation**: Fixed-width format must be maintained for downstream processing

---

### **WK001**
- **Data Type**: Numeric (decimal with 2 decimal places)
- **Purpose**: Working variable to accumulate net Secondary1Buys from SSSA activity records
- **Scope**: Local to CHECK.SSSA routine
- **Usage Pattern**:
  - Initialized to 0 at line 58
  - Accumulates SSSA buys (XI/B transactions) at line 63
  - Subtracts SSSA sells/reversals (XI/S transactions) at line 66
  - Final value replaces Secondary1Buys at line 69
- **Business Significance**: Calculates net loan activity accounting for reversals
- **Algorithm**: 
  - `WK001 = WK001 + Buy Amount` (for XI/B records)
  - `WK001 = WK001 - Sell Amount` (for XI/S records - reversals)
- **Business Rule**: Must process all SSSA records to get accurate net amount

---

## Variable Relationships and Dependencies

### Primary Processing Flow
1. **Date Variables**: RunDate → SevenDaysAgo, LastBusiness
2. **POPP Query Variables**: SevenDaysAgo, LastBusiness → RKPlan, TradeDate, Secondary1Buys, PriorCashApplied, TrustAccount
3. **SSSA Refinement**: RKPlan, TradeDate → WK001 → Secondary1Buys (modified)
4. **Output Generation**: Secondary1Buys → NewLoanUnits → Line → Output File
5. **Idempotency Update**: Secondary1Buys → POPP element 877 (PriorCashApplied)

### Critical Dependencies
- **FileName** depends on: `$XDAT` environment variable, system date/time
- **RunDate** depends on: `$RUN-DATE` environment variable (with fallback)
- **SevenDaysAgo, LastBusiness** depend on: RunDate (or current date)
- **All POPP variables** depend on: Successful POPP query with valid date range
- **Secondary1Buys** depends on: POPP element 741, SSSA activity (if exists)
- **Line** depends on: All POPP variables, LastBusiness, NewLoanUnits calculation

### Variable Mutation Summary
| Variable | Mutation Type | Mutation Location | Mutated By |
|----------|--------------|-------------------|------------|
| sd080 | One-time assignment | Line 11 | Direct assignment |
| FileName | One-time assignment | Lines 13-14 | OcText_string() construction |
| RunDate | One-time assignment | Line 18 | Environment variable read |
| SevenDaysAgo | One-time assignment | Line 20 or 23 | Date calculation |
| LastBusiness | One-time assignment | Line 21 or 24 | Business day calculation |
| RKPlan | Read multiple times | Lines 30, 39 | POPP object read |
| TradeDate | Read multiple times | Lines 31, 40 | POPP object read |
| Secondary1Buys | **Multiple mutations** | Lines 32, 69 | POPP read, then SSSA recalculation |
| PriorCashApplied | One-time read | Line 33 | POPP object read |
| NewLoanUnits | One-time calculation | Line 41 | Derived from Secondary1Buys |
| TrustAccount | One-time read | Line 42 | POPP object read |
| Line | Multiple assignments | Lines 43-48 | OcText_Set() calls |
| WK001 | Multiple accumulations | Lines 59, 63, 66 | SSSA loop accumulation |

---

## Environment Variables

### **$XDAT**
- **Purpose**: Base directory path for output files
- **Required**: Yes
- **Default**: None (must be set by environment)
- **Validation**: None in script (assumes valid path)
- **Used By**: FileName construction

### **$RUN-DATE**
- **Purpose**: Business date for batch processing (YYYYMMDD format)
- **Required**: No (falls back to current date if invalid or missing)
- **Default**: Current date (if not set or invalid)
- **Validation**: OcDate_Valid() function
- **Used By**: RunDate, date range calculations

---

## Data Dictionary Notes

### Buffer Overflow Risks
- **FileName**: LOW - Constructed from fixed-length components
- **Line**: MEDIUM - Must ensure OcText_Set() calls don't exceed buffer size (positions up to 138 documented)
- **TrustAccount**: LOW - Fixed 32-character field from database
- **RKPlan**: LOW - Fixed 6-character field

### Validation Gaps
- No validation that $XDAT is a valid directory path
- No validation that file write operations succeed
- No bounds checking on numeric calculations (Secondary1Buys, WK001)
- No validation of POPP/SSSA data integrity before processing

### Performance Considerations
- SSSA query executed for every POPP record with non-zero Secondary1Buys
- Nested loop structure (POPP outer, SSSA inner) may impact performance with large datasets
- No batch size limits or pagination

---

*AI-Generated Documentation - Review with COBOL/OmniScript experts for accuracy*
